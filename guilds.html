<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>OpsLink Servers</title>

<link href="https://fonts.cdnfonts.com/css/satoshi" rel="stylesheet">

<style>
:root{
  --bleed-background-1000:#0b0f14;
  --bleed-background-900:#0f141b;
  --bleed-background-800:#12161c;
  --bleed-border:#1f2630;
  --bleed-text:#f8fafc;
  --bleed-muted:#8b949e;
  --bleed-blue:#4ea1ff;
  --bleed-blue-glow:rgba(78,161,255,.25);
  --bleed-green:#22c55e;
  --bleed-yellow:#facc15;
  --bleed-red:#ef4444;
}

*{margin:0;padding:0;box-sizing:border-box;font-family:'Satoshi',sans-serif;}
html,body{height:100%;}

body{
  background:
    radial-gradient(circle at 15% 20%, rgba(78,161,255,.06), transparent 35%),
    radial-gradient(circle at 85% 80%, rgba(78,161,255,.04), transparent 40%),
    linear-gradient(180deg,var(--bleed-background-900),var(--bleed-background-1000));
  color:var(--bleed-text);
}

body::before{
  content:"";
  position:fixed;
  inset:0;
  background-image:url("https://grainy-gradients.vercel.app/noise.svg");
  opacity:.03;
  pointer-events:none;
}

/* ===== STARS ===== */
.stars{position:fixed;inset:0;pointer-events:none;z-index:0;}
.star{
  position:absolute;
  background:white;
  border-radius:50%;
  opacity:.6;
  animation:twinkle linear infinite;
}
@keyframes twinkle{
  0%,100%{opacity:.2}
  50%{opacity:.8}
}

/* ===== NAV ===== */
nav{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:28px 80px;
  z-index:1;
  position:relative;
}
.logo{font-weight:600;letter-spacing:.5px;}
.logout{
  color:var(--bleed-muted);
  cursor:pointer;
  font-size:14px;
}
.logout:hover{color:white}

/* ===== PAGE ===== */
.page{
  max-width:1200px;
  margin:80px auto;
  padding:0 40px;
  position:relative;
  z-index:1;
}

.page h1{
  font-size:42px;
  margin-bottom:12px;
}
.page p{
  color:var(--bleed-muted);
  margin-bottom:40px;
}

/* ===== GRID ===== */
.grid{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(320px,1fr));
  gap:30px;
}

.card{
  background:var(--bleed-background-800);
  border:1px solid var(--bleed-border);
  border-radius:20px;
  padding:25px;
  transition:.3s ease;
}
.card:hover{
  border-color:var(--bleed-blue);
  box-shadow:0 0 45px rgba(78,161,255,.12);
}

.server-header{
  display:flex;
  align-items:center;
  gap:15px;
  margin-bottom:15px;
}

.server-header img{
  width:56px;
  height:56px;
  border-radius:14px;
  object-fit:cover;
}

.server-name{
  font-size:18px;
  font-weight:600;
}

.server-desc{
  font-size:14px;
  color:var(--bleed-muted);
  margin-bottom:20px;
  line-height:1.6;
}

.meta{
  display:flex;
  justify-content:space-between;
  font-size:13px;
  margin-bottom:20px;
}

.status{
  font-weight:600;
}
.status.approved{color:var(--bleed-green);}
.status.pending{color:var(--bleed-yellow);}
.status.denied{color:var(--bleed-red);}

/* ===== BUTTON ===== */
.btn{
  display:block;
  width:100%;
  text-align:center;
  padding:12px;
  border-radius:12px;
  background:var(--bleed-blue);
  color:white;
  text-decoration:none;
  font-weight:600;
  box-shadow:0 0 35px var(--bleed-blue-glow);
  transition:.2s ease;
}
.btn:hover{
  transform:translateY(-2px);
  box-shadow:0 0 55px var(--bleed-blue-glow);
}

/* ===== EMPTY ===== */
.empty{
  color:var(--bleed-muted);
  text-align:center;
  padding:60px 0;
}
</style>
</head>
<body>

<div class="stars"></div>

<nav>
  <div class="logo">OpsLink Servers</div>
  <div class="logout" onclick="logout()">Logout</div>
</nav>

<div class="page">
  <h1>Your Servers</h1>
  <p>Manage and monitor your submitted Discord servers.</p>

  <div id="servers" class="grid"></div>
</div>

<script>
const API_URL = 'https://opslinkservers-backend.onrender.com';
const token = localStorage.getItem('opslinkToken');
const userStr = localStorage.getItem('opslinkUser');
if (!token || !userStr) window.location.href = 'index.html';

const user = JSON.parse(userStr);
const isAdmin = user.role === 'admin';

const container = document.getElementById('servers') || document.body;
let lastStatuses = {};

/* ===== FETCH HELPER ===== */
async function fetchWithAuth(url) {
  const res = await fetch(url, {
    headers: { Authorization: `Bearer ${token}` }
  });
  if (!res.ok) throw new Error('Failed to fetch');
  return res.json();
}

/* ===== RENDER SERVERS ===== */
function renderServers(servers) {
  container.innerHTML = '';
  if (!servers.length) {
    container.innerHTML = `<p class="text-zinc-400 text-center py-10">No servers found.</p>`;
    return;
  }

  servers.forEach(s => {
    const card = document.createElement('div');
    card.className = 'bg-zinc-900/80 border border-zinc-800 rounded-xl p-4 flex flex-col md:flex-row items-center gap-4 hover:shadow-lg transition-shadow';

    const logo = document.createElement('img');
    logo.src = s.logo || 'https://via.placeholder.com/80';
    logo.alt = s.name;
    logo.className = 'w-20 h-20 rounded-full object-cover border border-zinc-700';

    const info = document.createElement('div');
    info.className = 'flex-1 flex flex-col gap-1';

    const title = document.createElement('h3');
    title.className = 'text-xl font-semibold';
    title.textContent = s.name;

    const desc = document.createElement('p');
    desc.className = 'text-zinc-400 text-sm';
    desc.textContent = s.description || 'No description provided.';

    const meta = document.createElement('div');
    meta.className = 'flex items-center gap-4 mt-2 flex-wrap';

    const members = document.createElement('span');
    members.className = 'text-zinc-300 text-sm';
    members.textContent = `Members: ${s.members ?? 0}`;

    const status = document.createElement('span');
    status.textContent = s.status.toUpperCase();
    status.className = `px-2 py-1 rounded text-xs font-semibold ${
      s.status === 'approved' ? 'bg-green-500/30 text-green-400 border border-green-400' :
      s.status === 'denied' ? 'bg-red-500/30 text-red-400 border border-red-400' :
      'bg-yellow-500/30 text-yellow-400 border border-yellow-400'
    }`;

    meta.appendChild(members);
    meta.appendChild(status);

    const dashboardBtn = document.createElement('a');
    dashboardBtn.href = `dashboard.html?server=${s._id}`;
    dashboardBtn.className = 'mt-2 md:mt-0 inline-block bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded transition';
    dashboardBtn.textContent = 'View Dashboard';

    info.appendChild(title);
    info.appendChild(desc);
    info.appendChild(meta);

    card.appendChild(logo);
    card.appendChild(info);
    card.appendChild(dashboardBtn);

    container.appendChild(card);

    // Alert if status changed
    if (lastStatuses[s._id] && lastStatuses[s._id] !== s.status) {
      alert(`Server "${s.name}" status changed: ${s.status.toUpperCase()}`);
    }
    lastStatuses[s._id] = s.status;
  });
}

/* ===== LOAD SERVERS ===== */
async function loadServers() {
  try {
    const endpoint = isAdmin
      ? `${API_URL}/api/servers`   // admins see all approved servers
      : `${API_URL}/api/servers/mine`; // users see their own servers

    const servers = await fetchWithAuth(endpoint);
    renderServers(servers);
  } catch (err) {
    container.innerHTML = `<p class="text-red-500 text-center py-10">Error loading servers.</p>`;
    console.error(err);
  }
}

/* ===== INIT ===== */
loadServers();
setInterval(loadServers, 8000);
</script>

</body>
</html>
