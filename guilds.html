<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>OpsLink Servers</title>

<link href="https://fonts.cdnfonts.com/css/satoshi" rel="stylesheet">

<style>
:root{
  --bleed-background-1000:#0b0f14;
  --bleed-background-900:#0f141b;
  --bleed-background-800:#12161c;
  --bleed-border:#1f2630;
  --bleed-text:#f8fafc;
  --bleed-muted:#8b949e;
  --bleed-blue:#4ea1ff;
  --bleed-blue-glow:rgba(78,161,255,.25);
  --bleed-green:#22c55e;
  --bleed-yellow:#facc15;
  --bleed-red:#ef4444;
}

*{margin:0;padding:0;box-sizing:border-box;font-family:'Satoshi',sans-serif;}
html,body{height:100%;}

body{
  background:
    radial-gradient(circle at 15% 20%, rgba(78,161,255,.06), transparent 35%),
    radial-gradient(circle at 85% 80%, rgba(78,161,255,.04), transparent 40%),
    linear-gradient(180deg,var(--bleed-background-900),var(--bleed-background-1000));
  color:var(--bleed-text);
}

body::before{
  content:"";
  position:fixed;
  inset:0;
  background-image:url("https://grainy-gradients.vercel.app/noise.svg");
  opacity:.03;
  pointer-events:none;
}

/* ===== STARS ===== */
.stars{position:fixed;inset:0;pointer-events:none;z-index:0;}
.star{
  position:absolute;
  background:white;
  border-radius:50%;
  opacity:.6;
  animation:twinkle linear infinite;
}
@keyframes twinkle{
  0%,100%{opacity:.2}
  50%{opacity:.8}
}

/* ===== NAV ===== */
nav{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:28px 80px;
  z-index:1;
  position:relative;
}
.logo{font-weight:600;letter-spacing:.5px;}
.logout{
  color:var(--bleed-muted);
  cursor:pointer;
  font-size:14px;
}
.logout:hover{color:white}

/* ===== PAGE ===== */
.page{
  max-width:1200px;
  margin:80px auto;
  padding:0 40px;
  position:relative;
  z-index:1;
}

.page h1{
  font-size:42px;
  margin-bottom:12px;
}
.page p{
  color:var(--bleed-muted);
  margin-bottom:40px;
}

/* ===== GRID ===== */
.grid{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(320px,1fr));
  gap:30px;
}

.card{
  background:var(--bleed-background-800);
  border:1px solid var(--bleed-border);
  border-radius:20px;
  padding:25px;
  transition:.3s ease;
}
.card:hover{
  border-color:var(--bleed-blue);
  box-shadow:0 0 45px rgba(78,161,255,.12);
}

.server-header{
  display:flex;
  align-items:center;
  gap:15px;
  margin-bottom:15px;
}

.server-header img{
  width:56px;
  height:56px;
  border-radius:14px;
  object-fit:cover;
}

.server-name{
  font-size:18px;
  font-weight:600;
}

.server-desc{
  font-size:14px;
  color:var(--bleed-muted);
  margin-bottom:20px;
  line-height:1.6;
}

.meta{
  display:flex;
  justify-content:space-between;
  font-size:13px;
  margin-bottom:20px;
}

.status{
  font-weight:600;
}
.status.approved{color:var(--bleed-green);}
.status.pending{color:var(--bleed-yellow);}
.status.denied{color:var(--bleed-red);}

/* ===== BUTTON ===== */
.btn{
  display:block;
  width:100%;
  text-align:center;
  padding:12px;
  border-radius:12px;
  background:var(--bleed-blue);
  color:white;
  text-decoration:none;
  font-weight:600;
  box-shadow:0 0 35px var(--bleed-blue-glow);
  transition:.2s ease;
}
.btn:hover{
  transform:translateY(-2px);
  box-shadow:0 0 55px var(--bleed-blue-glow);
}

/* ===== EMPTY ===== */
.empty{
  color:var(--bleed-muted);
  text-align:center;
  padding:60px 0;
}
</style>
</head>
<body>

<div class="stars"></div>

<nav>
  <div class="logo">OpsLink Servers</div>
  <div class="logout" onclick="logout()">Logout</div>
</nav>

<div class="page">
  <h1>Your Servers</h1>
  <p>Manage and monitor your submitted Discord servers.</p>

  <div id="servers" class="grid"></div>
</div>

<script>
const API_URL = 'https://opslinkservers-backend.onrender.com';
const token = localStorage.getItem('opslinkToken');
const userStr = localStorage.getItem('opslinkUser');
if (!token || !userStr) window.location.href = 'index.html';

const user = JSON.parse(userStr);
const isAdmin = user.role === 'admin';

const container = document.getElementById('servers') || document.body; // adjust to your servers div

let lastStatuses = {};

/* ===== FETCH HELPERS ===== */
async function fetchWithAuth(url) {
  const res = await fetch(url, {
    headers: { Authorization: `Bearer ${token}` }
  });
  if (!res.ok) throw new Error('Failed to fetch');
  return res.json();
}

/* ===== RENDER SERVERS ===== */
function renderServers(servers) {
  container.innerHTML = '';
  if (!servers.length) {
    container.innerHTML = `<p class="text-zinc-400">No servers found.</p>`;
    return;
  }

  servers.forEach(s => {
    const div = document.createElement('div');
    div.className = `p-4 rounded border mb-3 ${
      s.status === 'approved' ? 'border-green-500 bg-green-900/30' :
      s.status === 'denied' ? 'border-red-500 bg-red-900/30' :
      'border-zinc-700 bg-zinc-900/50'
    }`;

    let statusMsg = '';
    if (s.status === 'pending') statusMsg = 'Pending review.';
    if (s.status === 'approved') statusMsg = 'Approved and live.';
    if (s.status === 'denied') statusMsg = `Denied: ${s.rejectionReason || 'No reason provided.'}`;

    if (lastStatuses[s._id] && lastStatuses[s._id] !== s.status) {
      alert(`Server "${s.name}" status changed: ${s.status.toUpperCase()}`);
    }
    lastStatuses[s._id] = s.status;

    div.innerHTML = `
      <h3 class="font-semibold text-lg">${s.name}</h3>
      <p class="text-sm text-zinc-300 mb-2">${statusMsg}</p>
      ${s.invite && s.status === 'approved' ? `<a href="${s.invite}" target="_blank" class="text-blue-400 underline text-sm">Join Server</a>` : ''}
      <a class="btn mt-2 inline-block" href="dashboard.html?server=${s._id}">View Dashboard</a>
    `;
    container.appendChild(div);
  });
}

/* ===== LOAD SERVERS ===== */
async function loadServers() {
  try {
    const endpoint = isAdmin
      ? `${API_URL}/api/servers` // admin sees approved servers
      : `${API_URL}/api/servers/mine`; // user sees only their servers

    const servers = await fetchWithAuth(endpoint);
    renderServers(servers);
  } catch (err) {
    container.innerHTML = `<p class="text-red-500">Error loading servers.</p>`;
    console.error(err);
  }
}

/* ===== INIT ===== */
loadServers();
setInterval(loadServers, 8000); // auto-refresh every 8s
</script>




</body>
</html>
